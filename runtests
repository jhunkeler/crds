#! /usr/bin/env python
import sys
import os
import os.path
import crds
from crds import config, log

os.chdir(os.path.dirname(sys.argv[0]) or ".")
topdir = os.getcwd()

# config.clear_crds_state()
# os.environ["CRDS_SERVER_URL"] = "https://hst-crds-dev.stsci.edu"

# Unlike historical CRDS with builtin cache,  test cache is now a separate 
# subversion checkout from ^/branches/crds_cache_test to ../crds_cache_test.
# os.environ["CRDS_MAPPATH"] = os.path.join(os.getcwd(), "..", "crds_cache_archive", "mappings")
os.environ["CRDS_CACHE_TEST"] = os.path.join(os.getcwd(), "..", "crds_cache_test")

EXTRA_PARAMETERS = " ".join(sys.argv[1:])

if  "--coverage" in sys.argv:
    sys.argv.remove("--coverage")
    COVERAGE_SWITCHES = " --with-coverage --cover-html --cover-html-dir={0}/coverage --cover-erase --cover-branches ".format(topdir)
    EXTRA_PARAMETERS += COVERAGE_SWITCHES
    
os.system("nosetests --verbose --with-doctest --doctest-tests --doctest-options=+ELLIPSIS,+NORMALIZE_WHITESPACE --logging-clear-handlers {0}".format(EXTRA_PARAMETERS))

